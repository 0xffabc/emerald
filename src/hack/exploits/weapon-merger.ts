import SocketController from "../../socket/controller/controller";
import { Weapon } from "../../world/objects/weapon";
import { Bazooka } from "../../world/weapons/bazooka";
import { CentralGun } from "../../world/weapons/central-gun";
import { CubeGun } from "../../world/weapons/cube-gun";
import { DoublePistol } from "../../world/weapons/double-pistol";
import { FlameThrower } from "../../world/weapons/flame-thrower";
import { GrowthGun } from "../../world/weapons/growth-gun";
import { HealGun } from "../../world/weapons/heal-gun";
import { ImpulseGun } from "../../world/weapons/impulse-gun";
import { Pistol } from "../../world/weapons/pistol";
import { RailGun } from "../../world/weapons/rail-gun";
import { Shotgun } from "../../world/weapons/shotgun";
import { Shuriken } from "../../world/weapons/shuriken";
import { Sword } from "../../world/weapons/sword";
import { World } from "../../world/world";
import { MouseListener } from "../concern/mouse-listener";
import type { Exploit } from "../exploit";

export class WeaponMerger extends MouseListener implements Exploit {
  public name = "Weapon merger";
  public description: string = "Merge 2 or 3 weapons into one";

  public weapons: Weapon[];

  /**
   * @name nameToWeapon
   * @description Converts a weapon name to a weapon instance
   * @param name The name of the weapon
   * @returns
   */
  public static nameToWeapon(name: string): Weapon {
    return new {
      RailGun: RailGun,
      RAIL_GUN: RailGun,
      Sword: Sword,
      SWORD: Sword,
      GrowthGun: GrowthGun,
      GROWTH_GUN: GrowthGun,
      Pistol: Pistol,
      PISTOL: Pistol,
      CubeGun: CubeGun,
      CUBE_GUN: CubeGun,
      ImpulseGun: ImpulseGun,
      IMPULSE_GUN: ImpulseGun,
      Bazooka: Bazooka,
      BAZOOKA: Bazooka,
      HealGun: HealGun,
      HEAL_GUN: HealGun,
      DoublePistol: DoublePistol,
      DOUBLE_PISTOL: DoublePistol,
      CentralGun: CentralGun,
      CENTRAL_GUN: CentralGun,
      Shotgun: Shotgun,
      SHOTGUN: Shotgun,
      FlameThrower: FlameThrower,
      FLAME_THROWER: FlameThrower,
      Shuriken: Shuriken,
      SHURIKEN: Shuriken,
    }[name]!();
  }

  /**
   * @name fromString
   * @description Creates a WeaponMerger from a string of weapon names
   * @param input The string of weapon names
   * @returns
   */
  public static fromString(input: string): WeaponMerger {
    const weapons = input.split(",").map((weapon) => this.nameToWeapon(weapon));

    return new WeaponMerger(weapons);
  }

  public constructor(weapons: Weapon[]) {
    super();

    this.weapons = weapons;

    this.rubberBand();
  }

  private rubberBand() {
    const weapon = this.weapons.at(0);

    if (!weapon) throw new Error("No weapon to begin with");

    World.myPlayer?.setWeapon(weapon);
  }

  protected override onRightMouseUp(): void {
    const id = World.myPlayer?.id;

    if (!id) return;

    if (World.myPlayer?.weapon?.id !== this.weapons.at(0)?.id) return;

    const weapons = this.weapons.slice(1, this.weapons.length);

    weapons.forEach((weapon) => {
      World.myPlayer?.setWeapon(weapon);

      const packet = weapon.toFireEvent(id);

      SocketController.simulateServerPacket(Array.from(packet));
    });

    this.rubberBand();
  }

  /**
   * @name destroy
   * @description Destroys the WeaponMerger
   */
  public destroy() {
    this.mouseDownListeners.forEach((listener) => {
      window.removeEventListener("mousedown", listener);
    });

    this.mouseUpListeners.forEach((listener) => {
      window.removeEventListener("mouseup", listener);
    });
  }

  /**
   * @name send
   * @description Deploys the first weapon in the list
   * @param _sid The session ID
   */
  public send(_sid: number): void {
    const weapon = this.weapons.at(0);

    if (!weapon) throw new Error("No weapon to begin with");

    World.myPlayer?.setWeapon(weapon);
  }
}
