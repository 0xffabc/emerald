import { to32xConvertedByte } from "../../packet/core/utils";
import SocketController from "../../socket/controller/controller";
import type { Exploit } from "../exploit";

export class ImmortalityExploit implements Exploit {
  name = "Immortality Exploit";
  description = "Allows the player to become immortal";

  id?: number;

  constructor(id: number) {
    this.id = id;
  }

  send() {
    if (typeof this.id !== "number") {
      throw new Error("Failed to apply Immortality Exploit: Invalid ID");
    }

    SocketController.simulateServerPacket([
      243,
      4,
      29,
      0,
      3,
      22,
      105,
      ...to32xConvertedByte(this.id!),
      70,
      68,
      0,
      0,
      0,
      1,
      115,
      0,
      17,
      115,
      112,
      97,
      119,
      110,
      82,
      111,
      108,
      101,
      77,
      111,
      100,
      101,
      84,
      121,
      112,
      101,
      105,
      0,
      0,
      0,
      0,
      254,
      105,
      0,
      0,
      0,
      0,
    ]);
    SocketController.simulateServerPacket([
      243,
      4,
      29,
      0,
      3,
      22,
      105,
      ...to32xConvertedByte(this.id!),
      70,
      68,
      0,
      0,
      0,
      1,
      115,
      0,
      6,
      104,
      101,
      97,
      108,
      116,
      104,
      102,
      ...new Uint8Array(new Float32Array([100]).buffer).reverse(),
      254,
      105,
      0,
      0,
      0,
      0,
    ]);
    SocketController.simulateServerPacket([
      243,
      4,
      29,
      0,
      3,
      22,
      105,
      ...to32xConvertedByte(this.id!),
      70,
      68,
      0,
      0,
      0,
      1,
      115,
      0,
      9,
      109,
      97,
      120,
      72,
      101,
      97,
      108,
      116,
      104,
      105,
      ...new Uint8Array(new Float32Array([100]).buffer).reverse(),
      254,
      105,
      0,
      0,
      0,
      0,
    ]);
    const effect_ = "SpawnProtection"
      .split("")
      .map((char) => char.charCodeAt(0));
    SocketController.simulateServerPacket([
      243,
      4,
      29,
      0,
      3,
      22,
      105,
      ...to32xConvertedByte(this.id!),
      70,
      68,
      0,
      0,
      0,
      1,
      115,
      0,
      9,
      109,
      111,
      100,
      105,
      102,
      105,
      101,
      114,
      115,
      68,
      0,
      0,
      0,
      1,
      115,
      0,
      effect_.length,
      95,
      ...new Uint8Array(new Uint32Array(effect_).buffer),
      98,
      0,
      254,
      105,
      0,
      0,
      0,
      0,
    ]);
    Uint8Array.prototype[2] = 0;
  }
}
